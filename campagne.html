<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Utilisateur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="user-panel.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <div class="user-dashboard">
    <div class="user-header">
      <div class="user-avatar" id="user-avatar">ðŸ‘¤</div>
      <div class="user-header-info">
        <h2 id="user-name">Espace Campagne</h2>
        <div class="user-email" id="user-email"></div>
        <div class="user-date" id="user-created"></div>
      </div>
      <div class="user-actions">
        <button class="btn-main" id="change-password-btn">Changer mon mot de passe</button>
        <button class="btn-main btn-logout" id="logout-btn">Se dÃ©connecter</button>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-value" id="stat-campagnes">0</div>
        <div class="stat-label">Campagnes</div>
      </div>
    </div>
    <div class="success" id="user-success"></div>
    <div class="error" id="user-error"></div>
    <div class="tickets-section">
      <h4>Toutes les campagnes</h4>
      <div id="no-campagnes" style="color:#888;"></div>
      <table class="tickets-table" id="campagnes-table" style="display:none;">
        <thead>
          <tr>
            <th>Nom</th>
            <th>DÃ©but</th>
            <th>Fin</th>
            <th>Zone</th>
            <th>Style</th>
            <th>Type</th>
            <th>Message</th>
            <th>Images</th>
            <th>VidÃ©os</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script>
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(async function(user) {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      document.getElementById('user-avatar').textContent = user.email ? user.email[0].toUpperCase() : 'ðŸ‘¤';
      document.getElementById('user-email').textContent = user.email;
      // Date d'inscription
      const userDoc = await db.collection('users').doc(user.uid).get();
      let created = '';
      if (userDoc.exists && userDoc.data().createdAt) {
        const d = userDoc.data().createdAt;
        created = d.seconds ? new Date(d.seconds * 1000).toLocaleString() : new Date(d).toLocaleString();
      } else if (user.metadata && user.metadata.creationTime) {
        created = new Date(user.metadata.creationTime).toLocaleString();
      }
      document.getElementById('user-created').textContent = 'Inscrit le : ' + created;

      // Affichage de toutes les campagnes
      const campagnesSnap = await db.collection('campagnes').orderBy('createdAt', 'desc').get();
      const campagnes = [];
      campagnesSnap.forEach(doc => {
        const c = doc.data();
        c._id = doc.id;
        campagnes.push(c);
      });
      document.getElementById('stat-campagnes').textContent = campagnes.length;
      const tableCamp = document.getElementById('campagnes-table');
      const tbodyCamp = tableCamp.querySelector('tbody');
      tbodyCamp.innerHTML = '';
      if (campagnes.length === 0) {
        document.getElementById('no-campagnes').textContent = 'Aucune campagne trouvÃ©e.';
        tableCamp.style.display = 'none';
      } else {
        document.getElementById('no-campagnes').textContent = '';
        tableCamp.style.display = '';
        campagnes.forEach(c => {
          const images = (c.images||[]).map(url => `<a href="${url}" target="_blank"><img src="${url}" style="max-width:40px;max-height:40px;border-radius:6px;margin:2px;"></a>`).join('');
          const videos = (c.videos||[]).map(url => `<a href="${url}" target="_blank">ðŸŽ¬</a>`).join(' ');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><a href="gererCampagne.html?id=${c._id}" style="color:#1976d2;font-weight:bold;text-decoration:underline;cursor:pointer;">${c.nom||''}</a></td>
            <td>${c.debut||''}</td>
            <td>${c.fin||''}</td>
            <td>${c.zone||''}</td>
            <td>${c.style||''}</td>
            <td>${c.type||''}</td>
            <td style="max-width:180px;overflow:auto;">${c.details||''}</td>
            <td>${images}</td>
            <td>${videos}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="window.location.href='gererCampagne.html?id=${c._id}'">Voir</button>
            </td>
          `;
          tbodyCamp.appendChild(tr);
        });
      }
    });

    document.getElementById('change-password-btn').onclick = function() {
      const user = auth.currentUser;
      if (!user) return;
      auth.sendPasswordResetEmail(user.email)
        .then(() => {
          document.getElementById('user-success').textContent = "Un email de rÃ©initialisation a Ã©tÃ© envoyÃ©.";
          document.getElementById('user-error').textContent = '';
        })
        .catch(err => {
          document.getElementById('user-error').textContent = err.message;
          document.getElementById('user-success').textContent = '';
        });
    };
    document.getElementById('logout-btn').onclick = function() {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    };
  </script>
</body>
</html>
