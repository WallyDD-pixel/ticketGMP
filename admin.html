<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="admin-facture.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    @media (min-width: 768px) {
      #burger-btn { display: none !important; }
      #sidebar { position: static !important; width: 15rem !important; min-height: 100vh; left: 0 !important; top: 0 !important; z-index: 20; box-shadow: none !important; }
      #main-content { margin-left: 1rem !important; padding-left: 2rem !important; }
    }
    @media (max-width: 767px) {
      #burger-btn { display: block !important; }
      #sidebar { position: fixed !important; left: 0; top: 0; width: 80vw !important; max-width: 320px; min-height: 100vh; z-index: 40; background: #1976d2 !important; box-shadow: 2px 0 16px #0002; transition: transform 0.2s; }
      #main-content { margin-left: 0 !important; padding-left: 0.5rem !important; padding-right: 0.5rem !important; }
      #sidebar.active + #sidebar-overlay { display: block; }
      #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.25); z-index: 30; }
    }
    .table-responsive {
      width: 100%;
      overflow-x: scroll;
      -webkit-overflow-scrolling: touch;
      max-width: 100vw;
      scrollbar-color: #1976d2 #e3eaf5;
      scrollbar-width: thin;
    }
    .table-responsive::-webkit-scrollbar {
      height: 10px;
      background: #e3eaf5;
      display: block;
    }
    .table-responsive::-webkit-scrollbar-thumb {
      background: #1976d2;
      border-radius: 6px;
    }
    .table-responsive::-webkit-scrollbar-track {
      background: #e3eaf5;
      border-radius: 6px;
    }
    @media (max-width: 900px) {
      #campagnes-table {
        min-width: 900px !important;
      }
    }
    @media (max-width: 767px) {
      #campagnes-table {
        min-width: 700px !important;
      }
    }
    /* Optionnel : effet visuel pour montrer le scroll */
    .table-responsive::-webkit-scrollbar {
      height: 8px;
      background: #e3eaf5;
    }
    .table-responsive::-webkit-scrollbar-thumb {
      background: #b3c6e0;
      border-radius: 4px;
    }
    /* Réduction de l'espace entre le menu et le tableau */
    .main-content {
      margin-left: 220px; /* ou la largeur de ton menu latéral */
      padding-top: 24px;
      padding-left: 24px;
      padding-right: 24px;
    }
    @media (max-width: 900px) {
      .main-content {
        margin-left: 0;
        padding-left: 8px;
        padding-right: 8px;
        padding-top: 12px;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <button id="burger-btn" aria-label="Ouvrir le menu" style="display:none;position:fixed;top:1rem;left:1rem;z-index:100;background:#1976d2;color:#fff;border-radius:8px;padding:0.3em 0.7em;box-shadow:0 2px 8px #b3c6e0;font-size:2rem;">&#9776;</button>
    <div class="flex min-h-screen">
      <!-- MENU -->
      <nav class="bg-blue-700 text-white w-60 min-h-screen flex flex-col px-4 py-6 fixed md:static z-20 transition-all duration-200 md:translate-x-0 -translate-x-full md:block" id="sidebar">
        <div class="flex flex-col items-center mb-8">
          <img src="gmp modif.png" alt="Logo GMP" class="w-16 h-16 rounded bg-white shadow p-2 mb-2">
          <span class="font-bold text-lg tracking-wide">GLOBAL MEDIAS PUB</span>
        </div>
        <ul class="flex-1 space-y-2">
          <li><a href="#" class="block px-4 py-2 rounded hover:bg-blue-800 font-semibold" id="menu-dashboard">Dashboard</a></li>
          <li><a href="#" class="block px-4 py-2 rounded hover:bg-blue-800 font-semibold" id="menu-campagnes">Campagnes</a></li>
          <li><a href="#" class="block px-4 py-2 rounded hover:bg-blue-800 font-semibold" id="menu-users">Utilisateurs</a></li>
          <li><a href="#" class="block px-4 py-2 rounded hover:bg-blue-800 font-semibold" id="menu-clients">Clients</a></li>
          <li><a href="#" class="block px-4 py-2 rounded hover:bg-blue-800 font-semibold" id="menu-tickets">Tickets</a></li>
          <li><a href="createTicket.html" class="block px-4 py-2 rounded hover:bg-blue-800 font-semibold">Créer un ticket</a></li>
          <li><a href="newsletter.html" class="block px-4 py-2 rounded hover:bg-blue-800 font-semibold">Créer une newsletter</a></li>
          <li><a href="createAnnonceur.html" class="block px-4 py-2 rounded hover:bg-blue-800 font-semibold">Créer une campagne</a></li>
        </ul>
        <button id="logout-btn" class="mt-8 px-4 py-2 bg-blue-900 text-white rounded hover:bg-red-600 font-bold">Se déconnecter</button>
      </nav>
      <div id="sidebar-overlay"></div>
      <div class="flex-1 ml-0 md:ml-60 p-6 transition-all duration-200 main-content" id="main-content" style="margin-top:3.5rem;">
        <!-- CONTENU PRINCIPAL -->
        <header class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4">
          <div>
            <h1 class="text-2xl font-bold text-blue-700">Admin Dashboard</h1>
            <div id="admin-email" class="text-gray-500 text-sm"></div>
          </div>
        </header>
        <div id="dashboard-section">
          <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded shadow p-6 text-center">
              <div class="text-3xl font-bold text-blue-700" id="stat-tickets">0</div>
              <div class="text-gray-500 mt-1">Tickets</div>
            </div>
            <div class="bg-white rounded shadow p-6 text-center">
              <div class="text-3xl font-bold text-blue-700" id="stat-users">0</div>
              <div class="text-gray-500 mt-1">Utilisateurs</div>
            </div>
            <div class="bg-white rounded shadow p-6 text-center">
              <div class="text-3xl font-bold text-blue-700" id="stat-newsletters">0</div>
              <div class="text-gray-500 mt-1">Newsletters</div>
            </div>
            <div class="bg-white rounded shadow p-6 text-center">
              <div class="text-3xl font-bold text-blue-700" id="stat-campagnes">0</div>
              <div class="text-gray-500 mt-1">Campagnes</div>
            </div>
          </div>
          <div class="mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 w-full overflow-x-auto" style="max-width:100vw;">
            <h2 class="text-xl font-bold text-blue-700 min-w-max">Toutes les campagnes</h2>
            <div class="flex gap-2">
              <button id="export-campagnes-csv" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">Exporter CSV</button>
              <input id="search-campagne" class="border border-gray-300 rounded px-3 py-2 w-full sm:w-80 min-w-[250px]" placeholder="Rechercher une campagne...">
            </div>
          </div>
          <div id="no-campagnes" class="text-gray-400 mb-2"></div>
          <div class="table-responsive w-full" style="max-width:100vw;">
            <table id="campagnes-table" class="min-w-[900px] bg-white rounded shadow text-sm" style="display:none;">
              <thead class="bg-blue-50">
                <tr>
                  <th class="px-3 py-2 text-left font-semibold text-blue-700">Distributeur</th>
                  <th class="px-3 py-2 text-left">Partenaire</th>
                  <th class="px-3 py-2 text-left">Nom</th>
                  <th class="px-3 py-2 text-left">Début</th>
                  <th class="px-3 py-2 text-left">Fin</th>
                  <th class="px-3 py-2 text-left">Durée</th>
                  <th class="px-3 py-2 text-left">Zone</th>
                  <th class="px-3 py-2 text-left">Style</th>
                  <th class="px-3 py-2 text-left">Type</th>
                  <th class="px-3 py-2 text-left">Type de fichier</th>
                  <th class="px-3 py-2 text-left">Rémunération Local</th>
                  <th class="px-3 py-2 text-left">Nombre société local</th>
                  <th class="px-3 py-2 text-left">Total Local</th>
                  <th class="px-3 py-2 text-left">Rémunération National</th>
                  <th class="px-3 py-2 text-left">Nombre société national</th>
                  <th class="px-3 py-2 text-left">Total National</th>
                  <th class="px-3 py-2 text-left">Message</th>
                  <th class="px-3 py-2 text-left">Images</th>
                  <th class="px-3 py-2 text-left">Vidéos</th>
                  <th class="px-3 py-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal édition campagne -->
    <div id="edit-campagne-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-2xl relative">
        <button id="close-edit-campagne-modal" class="absolute top-2 right-2 text-gray-400 hover:text-red-600 text-2xl">&times;</button>
        <h3 class="text-xl font-bold text-blue-700 mb-4">Modifier la campagne</h3>
        <form id="edit-campagne-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" id="edit-campagne-id">
          <div><label class="font-semibold">Nom du mandataire</label><input id="edit-distributeur" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Partenaire</label><input id="edit-partenaire" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Email</label><input id="edit-email" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Nom de la campagne</label><input id="edit-nom" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Début</label><input id="edit-debut" type="date" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Durée</label><input id="edit-duree" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Style</label><input id="edit-style" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Type</label><input id="edit-type" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Type de fichier</label><input id="edit-typeFichier" class="border rounded px-2 py-1 w-full"></div>
          <div><label class="font-semibold">Adresse fournisseur</label><input id="edit-adresse" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Rémunération Local (€)</label><input id="edit-remunerationLocal" type="number" step="0.01" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Nombre société local</label><input id="edit-nbSocieteLocal" type="number" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Rémunération National (€)</label><input id="edit-remunerationNational" type="number" step="0.01" class="border rounded px-2 py-1 w-full" required></div>
          <div><label class="font-semibold">Nombre société national</label><input id="edit-nbSocieteNational" type="number" class="border rounded px-2 py-1 w-full" required></div>
          <div class="md:col-span-2"><label class="font-semibold">Message</label><textarea id="edit-details" class="border rounded px-2 py-1 w-full" rows="2"></textarea></div>
          <div class="md:col-span-2 flex justify-end gap-2 mt-2">
            <button type="button" id="cancel-edit-campagne" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Annuler</button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Enregistrer</button>
          </div>
        </form>
        <div id="edit-campagne-error" class="text-red-600 mt-2"></div>
      </div>
    </div>
    <script>
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      let campagnesData = [];
      auth.onAuthStateChanged(async function(user) {
        if (!user) {
          window.location.href = "index.html";
          return;
        }
        document.getElementById('admin-email').textContent = user.email;
        // Stats
        db.collection('tickets').get().then(qs => document.getElementById('stat-tickets').textContent = qs.size);
        db.collection('users').get().then(qs => document.getElementById('stat-users').textContent = qs.size);
        db.collection('newsletters').get().then(qs => document.getElementById('stat-newsletters').textContent = qs.size);
        db.collection('campagnes').get().then(qs => document.getElementById('stat-campagnes').textContent = qs.size);
        // Campagnes
        db.collection('campagnes').orderBy('createdAt', 'desc').get().then((querySnapshot) => {
          campagnesData = [];
          querySnapshot.forEach((doc) => {
            const d = doc.data();
            d.id = doc.id;
            campagnesData.push(d);
          });
          renderCampagnesTable(campagnesData);
        });
      });
      function renderCampagnesTable(data) {
        const tableCamp = document.getElementById('campagnes-table');
        const tbodyCamp = tableCamp.querySelector('tbody');
        tbodyCamp.innerHTML = '';
        if (data.length === 0) {
          document.getElementById('no-campagnes').textContent = 'Aucune campagne trouvée.';
          tableCamp.style.display = 'none';
        } else {
          document.getElementById('no-campagnes').textContent = '';
          tableCamp.style.display = '';
          data.forEach(d => {
            const images = (d.images||[]).map(url => `<a href=\"${url}\" target=\"_blank\"><img src=\"${url}\" class=\"inline-block w-10 h-10 object-cover rounded mr-1 mb-1\"/></a>`).join('');
            const videos = (d.videos||[]).map(url => `<a href=\"${url}\" target=\"_blank\" class=\"text-blue-600\">🎬</a>`).join(' ');
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-blue-50';
            tr.innerHTML = `
              <td class=\"px-3 py-2\">${d.distributeur||''}</td>
              <td class=\"px-3 py-2\">${d.partenaire||''}</td>
              <td class=\"px-3 py-2\">${d.nom||''}</td>
              <td class=\"px-3 py-2\">${d.debut||''}</td>
              <td class=\"px-3 py-2\">${d.fin||''}</td>
              <td class=\"px-3 py-2\">${d.duree||''}</td>
              <td class=\"px-3 py-2\">${d.zone||''}</td>
              <td class=\"px-3 py-2\">${d.style||''}</td>
              <td class=\"px-3 py-2\">${d.type||''}</td>
              <td class=\"px-3 py-2\">${d.typeFichier||''}</td>
              <td class=\"px-3 py-2\">${d.localNational||''}</td>
              <td class=\"px-3 py-2\">${d.adresse||''}</td>
              <td class=\"px-3 py-2\">${d.contact||''}</td>
              <td class=\"px-3 py-2 text-green-700 font-bold\">${d.remunerationLocal ? d.remunerationLocal + ' €' : ''}</td>
              <td class=\"px-3 py-2 text-blue-700 font-bold\">${d.remunerationNational ? d.remunerationNational + ' €' : ''}</td>
              <td class=\"px-3 py-2 max-w-xs truncate\">${d.details||''}</td>
              <td class=\"px-3 py-2\">${images}</td>
              <td class=\"px-3 py-2\">${videos}</td>
              <td class=\"px-3 py-2\"><a href=\"gererCampagne.html?id=${d.id}\" class=\"px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700\">Voir</a></td>
            `;
            tbodyCamp.appendChild(tr);
          });
        }
      }
      document.getElementById('search-campagne').addEventListener('input', function() {
        const val = this.value.trim().toLowerCase();
        if (!val) {
          renderCampagnesTable(campagnesData);
          return;
        }
        const filtered = campagnesData.filter(d =>
          (d.nom||'').toLowerCase().includes(val) ||
          (d.partenaire||'').toLowerCase().includes(val) ||
          (d.distributeur||'').toLowerCase().includes(val)
        );
        renderCampagnesTable(filtered);
      });
      document.getElementById('logout-btn').onclick = function() {
        auth.signOut().then(() => {
          window.location.href = "index.html";
        });
      };
      // Responsive menu JS
      const sidebar = document.getElementById('sidebar');
      const burgerBtn = document.getElementById('burger-btn');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      function openSidebar() {
        sidebar.classList.remove('-translate-x-full');
        sidebar.classList.add('active');
        if (sidebarOverlay) sidebarOverlay.style.display = 'block';
      }
      function closeSidebar() {
        sidebar.classList.add('-translate-x-full');
        sidebar.classList.remove('active');
        if (sidebarOverlay) sidebarOverlay.style.display = 'none';
      }
      if (burgerBtn) {
        burgerBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          openSidebar();
        });
      }
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebar);
      }
      // Fermer le menu responsive après clic sur un lien du menu
      const sidebarLinks = sidebar.querySelectorAll('a');
      sidebarLinks.forEach(link => {
        link.addEventListener('click', function() {
          if (window.innerWidth < 768) {
            closeSidebar();
          }
        });
      });
      // Gestion de l'affichage des sections dashboard/campagnes/utilisateurs/tickets
      const dashboardSection = document.getElementById('dashboard-section');
      let campagnesSection = null;
      let usersSection = null;
      let ticketsSection = null;
      let clientsSection = null;

      function showSection(section) {
        dashboardSection.style.display = section === 'dashboard' ? '' : 'none';
        if (campagnesSection) campagnesSection.style.display = section === 'campagnes' ? '' : 'none';
        if (usersSection) usersSection.style.display = section === 'users' ? '' : 'none';
        if (ticketsSection) ticketsSection.style.display = section === 'tickets' ? '' : 'none';
        if (clientsSection) clientsSection.style.display = section === 'clients' ? '' : 'none';
      }

      document.getElementById('menu-dashboard').onclick = function() { showSection('dashboard'); };
      document.getElementById('menu-campagnes').onclick = function() {
        if (!campagnesSection) {
          campagnesSection = document.createElement('div');
          campagnesSection.innerHTML = `
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
              <h2 class="text-xl font-bold text-blue-700">Tableau des campagnes</h2>
              <div class="flex gap-2">
                <a href="createAnnonceur.html" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Créer une campagne</a>
                <button id="export-campagnes-crud-csv" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">Exporter CSV</button>
              </div>
            </div>
            <div id="campagne-crud-success" class="text-green-600 mb-2"></div>
            <div id="campagne-crud-error" class="text-red-600 mb-2"></div>
            <div class="table-responsive w-full" style="max-width:100vw;overflow-x:scroll;">
              <table id="campagnes-crud-table" class="min-w-[1100px] bg-white rounded shadow text-sm">
                <thead class="bg-blue-50">
                  <tr>
                    <th class="px-3 py-2 text-left font-semibold text-blue-700">Distributeur</th>
                    <th class="px-3 py-2 text-left">Partenaire</th>
                    <th class="px-3 py-2 text-left">Nom</th>
                    <th class="px-3 py-2 text-left">Début</th>
                    <th class="px-3 py-2 text-left">Fin</th>
                    <th class="px-3 py-2 text-left">Durée</th>
                    <th class="px-3 py-2 text-left">Zone</th>
                    <th class="px-3 py-2 text-left">Style</th>
                    <th class="px-3 py-2 text-left">Type</th>
                    <th class="px-3 py-2 text-left">Type de fichier</th>
                    <th class="px-3 py-2 text-left">Rémunération Local</th>
                    <th class="px-3 py-2 text-left">Nombre société local</th>
                    <th class="px-3 py-2 text-left">Total Local</th>
                    <th class="px-3 py-2 text-left">Rémunération National</th>
                    <th class="px-3 py-2 text-left">Nombre société national</th>
                    <th class="px-3 py-2 text-left">Total National</th>
                    <th class="px-3 py-2 text-left">Message</th>
                    <th class="px-3 py-2 text-left">Images</th>
                    <th class="px-3 py-2 text-left">Vidéos</th>
                    <th class="px-3 py-2 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="no-campagnes-crud" class="text-gray-400 mt-2"></div>
          `;
          dashboardSection.parentNode.appendChild(campagnesSection);

          // Ajout export CSV pour le tableau CRUD campagnes
          const exportBtn = campagnesSection.querySelector('#export-campagnes-crud-csv');
          exportBtn.addEventListener('click', function() {
            exportTableToCSV('campagnes-crud-table', 'campagnes.csv');
          });
        }
        showSection('campagnes');
        renderCampagnesCrudTable();
        // Ajout CRUD
        const campagneCrudSuccess = document.getElementById('campagne-crud-success');
        const campagneCrudError = document.getElementById('campagne-crud-error');
        const addCampagneForm = document.getElementById('add-campagne-form');
        addCampagneForm.onsubmit = async function(e) {
          e.preventDefault();
          campagneCrudSuccess.textContent = '';
          campagneCrudError.textContent = '';
          const nom = document.getElementById('add-campagne-nom').value.trim();
          const partenaire = document.getElementById('add-campagne-partenaire').value.trim();
          const distributeur = document.getElementById('add-campagne-distributeur').value.trim();
          if (!nom || !partenaire || !distributeur) {
            campagneCrudError.textContent = 'Tous les champs sont obligatoires.';
            return;
          }
          try {
            await db.collection('campagnes').add({
              nom,
              partenaire,
              distributeur,
              createdAt: new Date()
            });
            campagneCrudSuccess.textContent = 'Campagne ajoutée !';
            addCampagneForm.reset();
            renderCampagnesCrudTable();
          } catch (err) {
            campagneCrudError.textContent = err.message;
          }
        };
        // Remplacer la fonction renderCampagnesCrudTable pour remplir toutes les colonnes
        function renderCampagnesCrudTable() {
          const tbody = campagnesSection.querySelector('#campagnes-crud-table tbody');
          tbody.innerHTML = '';
          document.getElementById('no-campagnes-crud').textContent = '';
          db.collection('campagnes').orderBy('createdAt', 'desc').get().then((querySnapshot) => {
            if (querySnapshot.empty) {
              document.getElementById('no-campagnes-crud').textContent = 'Aucune campagne trouvée.';
              return;
            }
            querySnapshot.forEach((doc) => {
              const d = doc.data();
              const images = (d.images||[]).map(url => `<a href="${url}" target="_blank"><img src="${url}" class="inline-block w-10 h-10 object-cover rounded mr-1 mb-1"/></a>`).join('');
              const videos = (d.videos||[]).map(url => `<a href="${url}" target="_blank" class="text-blue-600">🎬</a>`).join(' ');
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="px-3 py-2">${d.distributeur||''}</td>
                <td class="px-3 py-2">${d.partenaire||''}</td>
                <td class="px-3 py-2">${d.nom||''}</td>
                <td class="px-3 py-2">${d.debut||''}</td>
                <td class="px-3 py-2">${d.fin||''}</td>
                <td class="px-3 py-2">${d.duree||''}</td>
                <td class="px-3 py-2">${d.zone||''}</td>
                <td class="px-3 py-2">${d.style||''}</td>
                <td class="px-3 py-2">${d.type||''}</td>
                <td class="px-3 py-2">${d.typeFichier||''}</td>
                <td class="px-3 py-2 text-green-700 font-bold">${d.remunerationLocal ? d.remunerationLocal + ' €' : ''}</td>
                <td class="px-3 py-2">${d.nbSocieteLocal||''}</td>
                <td class="px-3 py-2 text-green-800 font-bold">${d.totalLocal !== undefined ? d.totalLocal.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' €' : ''}</td>
                <td class="px-3 py-2 text-blue-700 font-bold">${d.remunerationNational ? d.remunerationNational + ' €' : ''}</td>
                <td class="px-3 py-2">${d.nbSocieteNational||''}</td>
                <td class="px-3 py-2 text-blue-800 font-bold">${d.totalNational !== undefined ? d.totalNational.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' €' : ''}</td>
                <td class="px-3 py-2 max-w-xs truncate">${d.details||''}</td>
                <td class="px-3 py-2">${images}</td>
                <td class="px-3 py-2">${videos}</td>
                <td class="px-3 py-2">
                  <a href="editCampagne.html?id=${doc.id}" class="text-blue-600 hover:underline mr-2">Modifier</a>
                  <button class="text-red-600 hover:underline mr-2" onclick="deleteCampagne('${doc.id}','${d.nom||''}')">Supprimer</button>
                  <a href="gererCampagne.html?id=${doc.id}" class="text-blue-700 hover:underline mr-2">Voir</a>
                  <button class="text-indigo-600 hover:underline" onclick="generateFacture('${doc.id}')">Générer une facture</button>
                  <button class="text-green-700 hover:underline" onclick="generateCampagnePDF('${doc.id}')">Générer PDF</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          });
        }
        // Place la fonction dans le scope global, après la création du tableau CRUD
        window.editCampagne = function(id, nom, partenaire, distributeur) {
          db.collection('campagnes').doc(id).get().then(doc => {
            if (!doc.exists) return;
            const d = doc.data();
            document.getElementById('edit-campagne-id').value = id;
            document.getElementById('edit-distributeur').value = d.distributeur || '';
            document.getElementById('edit-partenaire').value = d.partenaire || '';
            document.getElementById('edit-email').value = d.email || '';
            document.getElementById('edit-nom').value = d.nom || '';
            document.getElementById('edit-debut').value = d.debut || '';
            document.getElementById('edit-duree').value = d.duree || '';
            document.getElementById('edit-style').value = d.style || '';
            document.getElementById('edit-type').value = d.type || '';
            document.getElementById('edit-typeFichier').value = d.typeFichier || '';
            document.getElementById('edit-adresse').value = d.adresse || '';
            document.getElementById('edit-remunerationLocal').value = d.remunerationLocal || '';
            document.getElementById('edit-nbSocieteLocal').value = d.nbSocieteLocal || '';
            document.getElementById('edit-remunerationNational').value = d.remunerationNational || '';
            document.getElementById('edit-nbSocieteNational').value = d.nbSocieteNational || '';
            document.getElementById('edit-details').value = d.details || '';
            document.getElementById('edit-campagne-error').textContent = '';
            document.getElementById('edit-campagne-modal').classList.remove('hidden');
          });
        };
      } // <-- This closing brace was missing
      document.getElementById('close-edit-campagne-modal').onclick = function() {
        document.getElementById('edit-campagne-modal').classList.add('hidden');
      };
      document.getElementById('cancel-edit-campagne').onclick = function() {
        document.getElementById('edit-campagne-modal').classList.add('hidden');
      };
      document.getElementById('edit-campagne-form').onsubmit = async function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-campagne-id').value;
        const distributeur = document.getElementById('edit-distributeur').value.trim();
        const partenaire = document.getElementById('edit-partenaire').value.trim();
        const email = document.getElementById('edit-email').value.trim();
        const nom = document.getElementById('edit-nom').value.trim();
        const debut = document.getElementById('edit-debut').value;
        const duree = document.getElementById('edit-duree').value.trim();
        const style = document.getElementById('edit-style').value.trim();
        const type = document.getElementById('edit-type').value.trim();
        const typeFichier = document.getElementById('edit-typeFichier').value.trim();
        const adresse = document.getElementById('edit-adresse').value.trim();
        const remunerationLocal = document.getElementById('edit-remunerationLocal').value.trim();
        const remunerationNational = document.getElementById('edit-remunerationNational').value.trim();
        const nbSocieteLocal = document.getElementById('edit-nbSocieteLocal').value.trim();
        const nbSocieteNational = document.getElementById('edit-nbSocieteNational').value.trim();
        const details = document.getElementById('edit-details').value.trim();
        // Recalcule les totaux
        const totalLocal = (parseFloat(remunerationLocal.replace(',', '.')) || 0) * (parseInt(nbSocieteLocal) || 0);
        const totalNational = (parseFloat(remunerationNational.replace(',', '.')) || 0) * (parseInt(nbSocieteNational) || 0);
        try {
          await db.collection('campagnes').doc(id).update({
            distributeur, partenaire, email, nom, debut, duree, style, type, typeFichier, adresse,
            remunerationLocal, remunerationNational, nbSocieteLocal, nbSocieteNational, details,
            totalLocal, totalNational
          });
          document.getElementById('edit-campagne-modal').classList.add('hidden');
          renderCampagnesCrudTable();
        } catch (err) {
          document.getElementById('edit-campagne-error').textContent = err.message;
        }
      };
      document.getElementById('menu-users').onclick = function() {
        if (!usersSection) {
          usersSection = document.createElement('div');
          usersSection.innerHTML = `
            <h2 class="text-xl font-bold text-blue-700 mb-4">Tableau des utilisateurs</h2>
            <form id="add-user-form" class="mb-6 flex flex-col sm:flex-row gap-2 items-end">
              <input type="email" id="add-user-email" required placeholder="Email" class="border border-gray-300 rounded px-3 py-2" />
              <input type="password" id="add-user-password" required minlength="6" placeholder="Mot de passe" class="border border-gray-300 rounded px-3 py-2" />
              <input type="password" id="add-user-password-confirm" required minlength="6" placeholder="Confirmer le mot de passe" class="border border-gray-300 rounded px-3 py-2" />
              <select id="add-user-role" required class="border border-gray-300 rounded px-3 py-2">
                <option value="">Rôle</option>
                <option value="Admin">Admin</option>
                <option value="Campagne">Campagne</option>
                <option value="Tickets">Tickets</option>
              </select>
              <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Ajouter</button>
            </form>
            <div id="user-crud-success" class="text-green-600 mb-2"></div>
            <div id="user-crud-error" class="text-red-600 mb-2"></div>
            <div class="overflow-x-auto max-w-full">
              <table id="users-table" class="min-w-full bg-white rounded shadow text-sm">
                <thead class="bg-blue-50">
                  <tr>
                    <th class="px-3 py-2 text-left font-semibold text-blue-700">Email</th>
                    <th class="px-3 py-2 text-left">Date de création</th>
                    <th class="px-3 py-2 text-left">Rôle</th>
                    <th class="px-3 py-2 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="no-users" class="text-gray-400 mt-2"></div>
          `;
          dashboardSection.parentNode.appendChild(usersSection);

          // Correction : attacher l'onsubmit ici, après l'injection du formulaire
          const addUserForm = usersSection.querySelector('#add-user-form');
          const crudSuccess = usersSection.querySelector('#user-crud-success');
          const crudError = usersSection.querySelector('#user-crud-error');
          addUserForm.onsubmit = async function(e) {
            e.preventDefault();
            crudSuccess.textContent = '';
            crudError.textContent = '';
            const email = document.getElementById('add-user-email').value.trim();
            const password = document.getElementById('add-user-password').value;
            const passwordConfirm = document.getElementById('add-user-password-confirm').value;
            const role = document.getElementById('add-user-role').value;
            if (!email || !password || !role) {
              crudError.textContent = 'Tous les champs sont obligatoires.';
              return;
            }
            if (password !== passwordConfirm) {
              crudError.textContent = 'Les mots de passe ne correspondent pas.';
              return;
            }
            try {
              const user = firebase.auth().currentUser;
              if (!user) {
                crudError.textContent = "Vous devez être connecté en tant qu'admin.";
                return;
              }
              const idToken = await user.getIdToken();
              const response = await fetch('https://us-central1-trendy-c080e.cloudfunctions.net/createUser', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + idToken
                },
                body: JSON.stringify({ email, password })
              });
              const data = await response.json();
              if (!response.ok) {
                crudError.textContent = data.error || 'Erreur lors de la création.';
                return;
              }
              // Ajout Firestore avec le rôle
              await db.collection('users').doc(data.uid).set({ email, createdAt: new Date(), role });
              crudSuccess.textContent = 'Utilisateur ajouté !';
              addUserForm.reset();
              renderUsersTable();
            } catch (err) {
              crudError.textContent = err.message;
            }
          };
        }
        showSection('users');
        // Remplir le tableau utilisateurs
        const tbody = usersSection.querySelector('#users-table tbody');
        tbody.innerHTML = '';
        document.getElementById('no-users').textContent = '';
        db.collection('users').orderBy('createdAt', 'desc').get().then((querySnapshot) => {
          if (querySnapshot.empty) {
            document.getElementById('no-users').textContent = 'Aucun utilisateur trouvé.';
            return;
          }
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const tr = document.createElement('tr');
            let date = '';
            if (data.createdAt) {
              date = data.createdAt.seconds ? new Date(data.createdAt.seconds * 1000).toLocaleString() : new Date(data.createdAt).toLocaleString();
            }
            tr.innerHTML = `
              <td class="px-3 py-2">${data.email || ''}</td>
              <td class="px-3 py-2">${date}</td>
              <td class="px-3 py-2">${data.role || ''}</td>
              <td class="px-3 py-2">
                <button class="text-blue-600 hover:underline mr-2" onclick="editUser('${doc.id}','${data.email}','${data.role}')">Modifier</button>
                <button class="text-red-600 hover:underline" onclick="deleteUser('${doc.id}','${data.email}')">Supprimer</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
      };
      document.getElementById('menu-tickets').onclick = function() {
        if (!ticketsSection) {
          ticketsSection = document.createElement('div');
          ticketsSection.innerHTML = `
            <h2 class="text-xl font-bold text-blue-700 mb-4">Tableau des tickets</h2>
            <div class="table-responsive w-full" style="max-width:100vw;overflow-x:scroll;">
              <table id="tickets-table" class="min-w-full bg-white rounded shadow text-sm">
                <thead class="bg-blue-50">
                  <tr>
                    <th class="px-3 py-2 text-left font-semibold text-blue-700">Entreprise</th>
                    <th class="px-3 py-2 text-left">Titre</th>
                    <th class="px-3 py-2 text-left">Message</th>
                    <th class="px-3 py-2 text-left">Priorité</th>
                    <th class="px-3 py-2 text-left">Créé le</th>
                    <th class="px-3 py-2 text-left">Utilisateur</th>
                    <th class="px-3 py-2 text-left">État</th>
                    <th class="px-3 py-2 text-left">Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="no-tickets" class="text-gray-400 mt-2"></div>
          `;
          dashboardSection.parentNode.appendChild(ticketsSection);
        }
        showSection('tickets');
        renderTicketsTable();
        function renderTicketsTable() {
          const tbody = ticketsSection.querySelector('#tickets-table tbody');
          tbody.innerHTML = '';
          document.getElementById('no-tickets').textContent = '';
          db.collection('tickets').orderBy('createdAt', 'desc').get().then((querySnapshot) => {
            if (querySnapshot.empty) {
              document.getElementById('no-tickets').textContent = 'Aucun ticket trouvé.';
              return;
            }
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              let date = '';
              if (data.createdAt) {
                date = data.createdAt.seconds ? new Date(data.createdAt.seconds * 1000).toLocaleString() : new Date(data.createdAt).toLocaleString();
              }
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="px-3 py-2">${data.company || ''}</td>
                <td class="px-3 py-2">${data.title || ''}</td>
                <td class="px-3 py-2 max-w-xs truncate" title="${data.description || ''}">${data.description || ''}</td>
                <td class="px-3 py-2">${data.priority || ''}</td>
                <td class="px-3 py-2">${date}</td>
                <td class="px-3 py-2">${data.userEmail || data.lastname || ''}</td>
                <td class="px-3 py-2">${data.statut || ''}</td>
                <td class="px-3 py-2">
                  <button class="text-blue-600 hover:underline mr-2" onclick="editTicket('${doc.id}','${data.statut||''}')">Changer statut</button>
                  <button class="text-red-600 hover:underline" onclick="deleteTicket('${doc.id}')">Supprimer</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          });
        }
        window.editTicket = function(id, statut) {
          const newStatut = prompt('Nouveau statut du ticket ?', statut);
          if (!newStatut) return;
          db.collection('tickets').doc(id).update({ statut: newStatut }).then(() => {
            renderTicketsTable();
          });
        };
        window.deleteTicket = function(id) {
          if (!confirm('Supprimer ce ticket ?')) return;
          db.collection('tickets').doc(id).delete().then(() => {
            renderTicketsTable();
          });
        };
      };
      document.getElementById('menu-clients').onclick = function() {
        if (!clientsSection) {
          clientsSection = document.createElement('div');
          clientsSection.innerHTML = `
            <h2 class="text-xl font-bold text-blue-700 mb-4">Tableau des clients</h2>
            <div class="overflow-x-auto max-w-full">
              <table id="clients-table" class="min-w-full bg-white rounded shadow text-sm">
                <thead class="bg-blue-50">
                  <tr>
                    <th class="px-3 py-2 text-left font-semibold text-blue-700">Email</th>
                    <th class="px-3 py-2 text-left">Prénom</th>
                    <th class="px-3 py-2 text-left">Nom</th>
                    <th class="px-3 py-2 text-left">Société</th>
                    <th class="px-3 py-2 text-left">Date de modification</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="no-clients" class="text-gray-400 mt-2"></div>
          `;
          dashboardSection.parentNode.appendChild(clientsSection);
        }
        showSection('clients');
        renderClientsTable();
        function renderClientsTable() {
          const tbody = clientsSection.querySelector('#clients-table tbody');
          tbody.innerHTML = '';
          document.getElementById('no-clients').textContent = '';
          db.collection('utilisateur').orderBy('updatedAt', 'desc').get().then((querySnapshot) => {
            if (querySnapshot.empty) {
              document.getElementById('no-clients').textContent = 'Aucun client trouvé.';
              return;
            }
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              let date = '';
              if (data.updatedAt) {
                date = data.updatedAt.seconds ? new Date(data.updatedAt.seconds * 1000).toLocaleString() : new Date(data.updatedAt).toLocaleString();
              }
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="px-3 py-2">${data.email || ''}</td>
                <td class="px-3 py-2">${data.firstname || ''}</td>
                <td class="px-3 py-2">${data.lastname || ''}</td>
                <td class="px-3 py-2">${data.societe || ''}</td>
                <td class="px-3 py-2">${date}</td>
              `;
              tbody.appendChild(tr);
            });
          });
        }
      };
      // CRUD JS
      const crudSuccess = document.getElementById('user-crud-success');
      const crudError = document.getElementById('user-crud-error');
      const addUserForm = document.getElementById('add-user-form');
      addUserForm.onsubmit = async function(e) {
        e.preventDefault();
        crudSuccess.textContent = '';
        crudError.textContent = '';
        const email = document.getElementById('add-user-email').value.trim();
        const password = document.getElementById('add-user-password').value;
        const passwordConfirm = document.getElementById('add-user-password-confirm').value;
        const role = document.getElementById('add-user-role').value;
        if (!email || !password || !role) {
          crudError.textContent = 'Tous les champs sont obligatoires.';
          return;
        }
        if (password !== passwordConfirm) {
          crudError.textContent = 'Les mots de passe ne correspondent pas.';
          return;
        }
        try {
          const user = firebase.auth().currentUser;
          if (!user) {
            crudError.textContent = "Vous devez être connecté en tant qu'admin.";
            return;
          }
          const idToken = await user.getIdToken();
          const response = await fetch('https://us-central1-trendy-c080e.cloudfunctions.net/createUser', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + idToken
            },
            body: JSON.stringify({ email, password })
          });
          const data = await response.json();
          if (!response.ok) {
            crudError.textContent = data.error || 'Erreur lors de la création.';
            return;
          }
          // Ajout Firestore avec le rôle
          await db.collection('users').doc(data.uid).set({ email, createdAt: new Date(), role });
          crudSuccess.textContent = 'Utilisateur ajouté !';
          addUserForm.reset();
          renderUsersTable();
        } catch (err) {
          crudError.textContent = err.message;
        }
      };
      function renderUsersTable() {
        const tbody = usersSection.querySelector('#users-table tbody');
        tbody.innerHTML = '';
        document.getElementById('no-users').textContent = '';
        db.collection('users').orderBy('createdAt', 'desc').get().then((querySnapshot) => {
          if (querySnapshot.empty) {
            document.getElementById('no-users').textContent = 'Aucun utilisateur trouvé.';
            return;
          }
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const tr = document.createElement('tr');
            let date = '';
            if (data.createdAt) {
              date = data.createdAt.seconds ? new Date(data.createdAt.seconds * 1000).toLocaleString() : new Date(data.createdAt).toLocaleString();
            }
            tr.innerHTML = `
              <td class="px-3 py-2">${data.email || ''}</td>
              <td class="px-3 py-2">${date}</td>
              <td class="px-3 py-2">${data.role || ''}</td>
              <td class="px-3 py-2">
                <button class="text-blue-600 hover:underline mr-2" onclick="editUser('${doc.id}','${data.email}','${data.role}')">Modifier</button>
                <button class="text-red-600 hover:underline" onclick="deleteUser('${doc.id}','${data.email}')">Supprimer</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
      }
      window.editUser = function(id, email, role) {
        const newRole = prompt('Nouveau rôle pour ' + email + ' ?', role);
        if (!newRole) return;
        db.collection('users').doc(id).update({ role: newRole }).then(() => {
          crudSuccess.textContent = 'Rôle mis à jour !';
          renderUsersTable();
        }).catch(e => { crudError.textContent = e.message; });
      };
      window.deleteUser = function(id, email) {
        if (!confirm('Supprimer l’utilisateur ' + email + ' ?')) return;
        db.collection('users').doc(id).delete().then(() => {
          crudSuccess.textContent = 'Utilisateur supprimé !';
          renderUsersTable();
        }).catch(e => { crudError.textContent = e.message; });
      };
      renderUsersTable();
      // Fonction d'export CSV pour le tableau des campagnes
      function exportTableToCSV(tableId, filename) {
        const table = document.getElementById(tableId);
        let csv = [];
        const rows = table.querySelectorAll('tr');
        for (let i = 0; i < rows.length; i++) {
          let row = [], cols = rows[i].querySelectorAll('th, td');
          for (let j = 0; j < cols.length - 1; j++) { // -1 pour ignorer la colonne Actions
            let text = cols[j].innerText.replace(/\n/g, ' ').replace(/\s+/g, ' ').replace(/"/g, '""');
            row.push('"' + text + '"');
          }
          csv.push(row.join(','));
        }
        const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
        const downloadLink = document.createElement('a');
        downloadLink.download = filename;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      }
      document.getElementById('export-campagnes-csv').addEventListener('click', function() {
        exportTableToCSV('campagnes-table', 'campagnes.csv');
      });
      function generateCampagnePDF(id) {
        window.location.href = "facture.html?id=" + encodeURIComponent(id);
      }
      
    </script>
</body>
</html>
