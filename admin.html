<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Tableau de bord</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --main-color: #1976d2;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(120deg, #e3f0ff 0%, #f5f5f5 100%);
      margin: 0;
      min-height: 100vh;
    }
    .admin-layout {
      display: flex;
      min-height: 100vh;
    }
    .admin-menu {
      width: 240px;
      background: linear-gradient(180deg, var(--main-color) 60%, #1565c0 100%);
      color: #fff;
      min-height: 100vh;
      box-shadow: 2px 0 12px #b3c6e0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 0;
    }
    .admin-menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
    }
    .admin-menu li {
      border-bottom: 1px solid #1565c0;
    }
    .admin-menu a {
      display: block;
      color: #fff;
      text-decoration: none;
      padding: 18px 32px;
      font-size: 1.1em;
      letter-spacing: 0.5px;
      transition: background 0.2s, padding-left 0.2s;
      position: relative;
      border-radius: 0 20px 20px 0;
    }
    .admin-menu a:hover, .admin-menu a.active {
      background: #1251a3;
      padding-left: 44px;
    }
    .admin-menu a#logout-link {
      color: #ffbdbd;
      font-weight: bold;
      border-top: 1px solid #1251a3;
      margin-top: auto;
      background: #183c5a;
      transition: background 0.2s;
    }
    .admin-menu a#logout-link:hover {
      background: #c62828;
      color: #fff;
    }
    .admin-container {
      flex: 1;
      max-width: 1100px;
      margin: 40px auto;
      padding: 48px 40px 32px 40px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 32px #b3c6e0;
      min-height: 80vh;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    h1 {
      color: var(--main-color);
      font-size: 2.3em;
      margin-bottom: 0.2em;
      font-weight: 700;
    }
    h2 {
      color: #333;
      font-size: 1.5em;
      margin-top: 20px;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    #user-info {
      color: #555;
      font-size: 1.1em;
      margin-bottom: 18px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #f9fbfd;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px #e3eaf7;
    }
    th, td {
      border: 1px solid #e3eaf7;
      padding: 14px 12px;
      text-align: left;
      font-size: 1em;
    }
    th {
      background: #e3f0ff;
      color: var(--main-color);
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    tr:nth-child(even) td {
      background: #f5faff;
    }
    tr:hover td {
      background: #e3f0ff;
      transition: background 0.2s;
    }
    .gerer-ticket-btn, .btn-main {
      background: linear-gradient(90deg, var(--main-color) 60%, #42a5f5 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 26px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 8px #b3c6e0;
      transition: background 0.2s, transform 0.1s;
      margin: 0 4px;
      letter-spacing: 0.5px;
      display: inline-block;
    }
    .gerer-ticket-btn:hover, .btn-main:hover {
      background: linear-gradient(90deg, #1251a3 60%, var(--main-color) 100%);
      transform: scale(1.07);
      color: #fff;
    }
    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #b3c6e0;
      font-size: 1.08em;
      background: #f9fbfd;
      margin-bottom: 12px;
    }
    .success { color: #388e3c; margin-top: 18px; }
    .error { color: #d32f2f; margin-top: 18px; }
    @media (max-width: 1100px) {
      .admin-container { max-width: 99vw; padding: 20px 2vw; }
      .admin-menu { width: 140px; }
      .admin-menu a { font-size: 0.98em; padding: 14px 12px; }
    }
  </style>
  <!-- Firebase App (core SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <!-- Firebase Auth SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <!-- Firebase Firestore SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
    <div class="admin-layout">
      <nav class="admin-menu">
        <ul>
          <li><a href="#dashboard" id="menu-dashboard">Tableau de bord</a></li>
          <li><a href="#users" id="menu-users">Utilisateurs</a></li>
          <li><a href="#settings" id="menu-settings">Paramètres</a></li>
          <li><a href="#tickets" id="menu-tickets">Tickets</a></li>
          <li><a href="#newsletter" id="menu-newsletter">Créer une newsletter</a></li>
          <li><a href="#utilisateur" id="menu-utilisateur">Utilisateurs (tickets)</a></li>
          <li><a href="#logout" id="logout-link" style="color:#ffbdbd;">Se déconnecter</a></li>
        </ul>
      </nav>
      <div class="admin-container">
        <div id="page-dashboard">
          <!-- Logo GMP -->
          <div style="text-align:center;margin-bottom:18px;">
            <img src="gmp%20modif.png" alt="Logo GMP" style="max-width:220px;width:70%;height:auto;filter:drop-shadow(0 2px 8px #b3c6e0);">
          </div>
          <h1>Bienvenue sur la page Admin</h1>
          <p id="user-info"></p>
          <!-- Dashboard Statistiques -->
          <div id="dashboard-stats" style="display:flex;gap:32px;justify-content:center;margin:32px 0 18px 0;flex-wrap:wrap;">
            <div class="stat-card" style="background:linear-gradient(120deg,#e3f0ff 60%,#f5f5f5 100%);box-shadow:0 2px 12px #b3c6e0;border-radius:12px;padding:28px 38px;min-width:180px;text-align:center;">
              <div style="font-size:2.2em;font-weight:bold;color:#1976d2;" id="stat-tickets">0</div>
              <div style="font-size:1.1em;color:#333;">Tickets</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(120deg,#e3f0ff 60%,#f5f5f5 100%);box-shadow:0 2px 12px #b3c6e0;border-radius:12px;padding:28px 38px;min-width:180px;text-align:center;">
              <div style="font-size:2.2em;font-weight:bold;color:#1976d2;" id="stat-users">0</div>
              <div style="font-size:1.1em;color:#333;">Utilisateurs</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(120deg,#e3f0ff 60%,#f5f5f5 100%);box-shadow:0 2px 12px #b3c6e0;border-radius:12px;padding:28px 38px;min-width:180px;text-align:center;">
              <div style="font-size:2.2em;font-weight:bold;color:#1976d2;" id="stat-newsletters">0</div>
              <div style="font-size:1.1em;color:#333;">Newsletters</div>
            </div>
          </div>
        </div>
        <div id="page-users" style="display:none">
          <h2>Liste des utilisateurs</h2>
          <table id="users-table" style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:#f0f0f0">
                <th style="border:1px solid #ccc;padding:8px;">Email</th>
                <th style="border:1px solid #ccc;padding:8px;">Date de création</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="page-utilisateur" style="display:none">
          <h2>Liste des utilisateurs (tickets)</h2>
          <table id="utilisateur-table" style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:#f0f0f0">
                <th style="border:1px solid #ccc;padding:8px;">Nom</th>
                <th style="border:1px solid #ccc;padding:8px;">Email</th>
                <th style="border:1px solid #ccc;padding:8px;">Date de mise à jour</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="page-settings" style="display:none">
          <h2>Paramètres</h2>
          <div style="max-width:500px;margin:0 auto 24px auto;padding:24px 28px;background:#f9fbfd;border-radius:10px;box-shadow:0 2px 8px #e3eaf7;">
            <h3 style="color:#1976d2;margin-top:0;">Personnalisation</h3>
            <label for="settings-app-name" style="font-weight:500;">Nom de l'application</label>
            <input type="text" id="settings-app-name" style="width:100%;padding:10px;margin-bottom:14px;border-radius:6px;border:1px solid #b3c6e0;font-size:1.05em;">
            <label for="settings-color" style="font-weight:500;">Couleur principale</label>
            <input type="color" id="settings-color" value="#1976d2" style="width:60px;height:36px;padding:0;margin-bottom:18px;border:none;">
            <button id="settings-save-btn" style="margin-top:10px;padding:10px 0;width:100%;background:linear-gradient(90deg,#1976d2 60%,#42a5f5 100%);color:#fff;font-size:1.1em;border:none;border-radius:6px;box-shadow:0 2px 8px #b3c6e0;cursor:pointer;">Enregistrer</button>
            <div class="success" id="settings-success"></div>
          </div>
          <div style="max-width:500px;margin:0 auto 24px auto;padding:24px 28px;background:#f9fbfd;border-radius:10px;box-shadow:0 2px 8px #e3eaf7;">
            <h3 style="color:#1976d2;margin-top:0;">Exportation</h3>
            <button id="export-tickets-btn" style="padding:10px 0;width:100%;background:linear-gradient(90deg,#1976d2 60%,#42a5f5 100%);color:#fff;font-size:1.1em;border:none;border-radius:6px;box-shadow:0 2px 8px #b3c6e0;cursor:pointer;">Exporter les tickets (CSV)</button>
            <div class="success" id="export-success"></div>
          </div>
        </div>
        <div id="page-tickets" style="display:none">
          <h2>Liste des tickets d'intervention</h2>
          <table id="tickets-table">
            <thead>
              <tr>
                <th>Entreprise</th>
                <th>Titre</th>
                <th>Message</th>
                <th>Priorité</th>
                <th>Créé le</th>
                <th>Utilisateur</th>
                <th>État</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="page-newsletter" style="display:none">
          <h2>Créer une newsletter</h2>
          <form id="newsletter-form" style="max-width:600px;margin-bottom:24px;">
            <label for="newsletter-title">Titre</label>
            <input type="text" id="newsletter-title" name="newsletter-title" required style="width:100%;padding:12px;margin-bottom:16px;border-radius:6px;border:1px solid #b3c6e0;font-size:1.1em;">
            <label for="newsletter-content">Contenu</label>
            <div style="margin-bottom:12px;">
              <textarea id="newsletter-content" name="newsletter-content" required style="width:100%;min-height:160px;padding:12px;border-radius:6px;border:1px solid #b3c6e0;font-size:1.05em;" placeholder="Vous pouvez insérer du HTML, des images, etc.
Exemple : &lt;img src='https://...' width='200'&gt;"></textarea>
            </div>
            <label for="newsletter-users">Destinataires</label>
            <select id="newsletter-users" name="newsletter-users" multiple style="width:100%;min-height:80px;padding:10px;border-radius:6px;border:1px solid #b3c6e0;font-size:1.05em;margin-bottom:12px;"></select>
            <small style="color:#888;">Maintenez Ctrl (Windows) ou Cmd (Mac) pour sélectionner plusieurs utilisateurs</small>
            <button type="submit" style="margin-top:18px;padding:12px 0;width:100%;background:linear-gradient(90deg,#1976d2 60%,#42a5f5 100%);color:#fff;font-size:1.1em;border:none;border-radius:6px;box-shadow:0 2px 8px #b3c6e0;cursor:pointer;">Créer la newsletter</button>
            <div class="success" id="newsletter-success"></div>
            <div class="error" id="newsletter-error"></div>
          </form>
          <h2>Historique des newsletters</h2>
          <ul id="newsletter-list"></ul>
        </div>
      </div>
    </div>
    <script>
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      function afficherUtilisateurs() {
        db.collection('users').get().then((querySnapshot) => {
          const tbody = document.querySelector('#users-table tbody');
          tbody.innerHTML = '';
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style='border:1px solid #ccc;padding:8px;'>${data.email}</td><td style='border:1px solid #ccc;padding:8px;'>${data.createdAt ? (data.createdAt.seconds ? new Date(data.createdAt.seconds * 1000).toLocaleString() : new Date(data.createdAt).toLocaleString()) : ''}</td>`;
            tbody.appendChild(tr);
          });
        });
      }

      function afficherUtilisateursTickets() {
        db.collection('utilisateur').orderBy('updatedAt', 'desc').get().then((querySnapshot) => {
          const tbody = document.querySelector('#utilisateur-table tbody');
          tbody.innerHTML = '';
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style='border:1px solid #ccc;padding:8px;'>${data.lastname || ''}</td><td style='border:1px solid #ccc;padding:8px;'>${data.email || ''}</td><td style='border:1px solid #ccc;padding:8px;'>${data.updatedAt ? (data.updatedAt.seconds ? new Date(data.updatedAt.seconds * 1000).toLocaleString() : new Date(data.updatedAt).toLocaleString()) : ''}</td>`;
            tbody.appendChild(tr);
          });
        });
      }

      function afficherTickets() {
        db.collection('tickets').orderBy('createdAt', 'desc').get().then((querySnapshot) => {
          const tbody = document.querySelector('#tickets-table tbody');
          tbody.innerHTML = '';
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${data.company || ''}</td>
              <td>${data.title || ''}</td>
              <td>${data.description || ''}</td>
              <td>${data.priority || ''}</td>
              <td>${data.createdAt ? (data.createdAt.seconds ? new Date(data.createdAt.seconds * 1000).toLocaleString() : new Date(data.createdAt).toLocaleString()) : ''}</td>
              <td>${data.userEmail || ''}</td>
              <td>${data.etat || 'Nouveau'}</td>
              <td><button class="gerer-ticket-btn" data-id="${doc.id}">Gérer</button></td>
            `;
            tbody.appendChild(tr);
          });
          // Ajout des listeners sur les boutons Gérer
          document.querySelectorAll('.gerer-ticket-btn').forEach(btn => {
            btn.onclick = function() {
              const ticketId = this.getAttribute('data-id');
              window.location.href = `gererTicket.html?id=${ticketId}`;
            };
          });
        });
      }

      function afficherNewsletters() {
        db.collection('newsletters').orderBy('createdAt', 'desc').get().then((querySnapshot) => {
          const list = document.getElementById('newsletter-list');
          list.innerHTML = '';
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const li = document.createElement('li');
            li.innerHTML = `<b>${data.title || ''}</b> <span style='color:#888;font-size:0.95em;'>(${data.createdAt ? (data.createdAt.seconds ? new Date(data.createdAt.seconds * 1000).toLocaleString() : new Date(data.createdAt).toLocaleString()) : ''})</span><br><div style='margin:6px 0 12px 0;'>${data.content || ''}</div><div style='color:#1976d2;font-size:0.98em;margin-bottom:8px;'><b>Destinataires :</b> ${(data.recipients || []).join(', ')}</div>`;
            list.appendChild(li);
          });
        });
      }

      // Statistiques dashboard
      function chargerStatsDashboard() {
        // Tickets
        db.collection('tickets').get().then((qs) => {
          document.getElementById('stat-tickets').textContent = qs.size;
        });
        // Utilisateurs
        db.collection('users').get().then((qs) => {
          document.getElementById('stat-users').textContent = qs.size;
        });
        // Newsletters
        db.collection('newsletters').get().then((qs) => {
          document.getElementById('stat-newsletters').textContent = qs.size;
        });
      }

      function showPage(page) {
        document.getElementById('page-dashboard').style.display = page === 'dashboard' ? '' : 'none';
        document.getElementById('page-users').style.display = page === 'users' ? '' : 'none';
        document.getElementById('page-tickets').style.display = page === 'tickets' ? '' : 'none';
        document.getElementById('page-settings').style.display = page === 'settings' ? '' : 'none';
        document.getElementById('page-newsletter').style.display = page === 'newsletter' ? '' : 'none';
        document.getElementById('page-utilisateur').style.display = page === 'utilisateur' ? '' : 'none';
        if(page === 'users') afficherUtilisateurs();
        if(page === 'tickets') afficherTickets();
        if(page === 'newsletter') afficherNewsletters();
        if(page === 'dashboard') chargerStatsDashboard();
        if(page === 'utilisateur') afficherUtilisateursTickets();
      }

      function chargerUtilisateursNewsletter() {
        const select = document.getElementById('newsletter-users');
        if (!select) return;
        db.collection('users').get().then((querySnapshot) => {
          select.innerHTML = '';
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const option = document.createElement('option');
            option.value = data.email;
            option.textContent = data.email;
            select.appendChild(option);
          });
        });
      }

      document.getElementById('menu-dashboard').onclick = function() { showPage('dashboard'); };
      document.getElementById('menu-users').onclick = function() { showPage('users'); };
      document.getElementById('menu-settings').onclick = function() { showPage('settings'); };
      document.getElementById('menu-tickets').onclick = function() { showPage('tickets'); };
      document.getElementById('menu-newsletter').onclick = function() {
        showPage('newsletter');
        chargerUtilisateursNewsletter();
      };
      document.getElementById('menu-utilisateur').onclick = function() {
        showPage('utilisateur');
      };
      document.getElementById('logout-link').onclick = function(e) {
        e.preventDefault();
        auth.signOut().then(function() {
          window.location.href = "index.html";
        });
      };

      auth.onAuthStateChanged(function(user) {
        if (user) {
          document.getElementById('user-info').textContent = `Connecté en tant que : ${user.email}`;
          showPage('dashboard');
          chargerStatsDashboard();
        } else {
          window.location.href = "index.html";
        }
      });

      // Gestion du formulaire de newsletter
      document.getElementById('newsletter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const title = document.getElementById('newsletter-title').value.trim();
        const content = document.getElementById('newsletter-content').value.trim();
        const usersSelect = document.getElementById('newsletter-users');
        const selectedUsers = Array.from(usersSelect.selectedOptions).map(opt => opt.value);
        const successDiv = document.getElementById('newsletter-success');
        const errorDiv = document.getElementById('newsletter-error');
        successDiv.textContent = '';
        errorDiv.textContent = '';
        if (!title || !content || selectedUsers.length === 0) {
          errorDiv.textContent = "Veuillez remplir tous les champs et sélectionner au moins un destinataire.";
          return;
        }
        db.collection('newsletters').add({
          title,
          content,
          recipients: selectedUsers,
          createdAt: new Date()
        })
        .then(() => {
          successDiv.textContent = "Newsletter créée avec succès !";
          document.getElementById('newsletter-form').reset();
          afficherNewsletters();
        })
        .catch((err) => {
          errorDiv.textContent = "Erreur lors de la création : " + err.message;
        });
      });

      // Chargement des utilisateurs dans le sélecteur de destinataires
      db.collection('users').get().then((querySnapshot) => {
        const select = document.getElementById('newsletter-users');
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const option = document.createElement('option');
          option.value = data.email;
          option.textContent = data.email;
          select.appendChild(option);
        });
      });

      // Gestion des paramètres
      document.getElementById('settings-save-btn').onclick = function() {
        const appName = document.getElementById('settings-app-name').value.trim();
        const color = document.getElementById('settings-color').value;
        localStorage.setItem('appName', appName);
        localStorage.setItem('mainColor', color);
        document.getElementById('settings-success').textContent = "Paramètres enregistrés (local) !";
        // Changement dynamique de la couleur principale
        document.documentElement.style.setProperty('--main-color', color);
        // Mettre à jour le menu et les boutons
        document.querySelectorAll('.admin-menu').forEach(el => el.style.background = `linear-gradient(180deg, ${color} 60%, #1565c0 100%)`);
        document.querySelectorAll('th').forEach(el => el.style.color = color);
        document.querySelectorAll('.gerer-ticket-btn').forEach(el => el.style.background = `linear-gradient(90deg, ${color} 60%, #42a5f5 100%)`);
        document.querySelector('h1').style.color = color;
      };
      // Appliquer les paramètres au chargement
      window.addEventListener('DOMContentLoaded', function() {
        const appName = localStorage.getItem('appName');
        const color = localStorage.getItem('mainColor');
        if(appName) document.getElementById('settings-app-name').value = appName;
        if(color) {
          document.getElementById('settings-color').value = color;
          document.documentElement.style.setProperty('--main-color', color);
          document.querySelectorAll('.admin-menu').forEach(el => el.style.background = `linear-gradient(180deg, ${color} 60%, #1565c0 100%)`);
          document.querySelectorAll('th').forEach(el => el.style.color = color);
          document.querySelectorAll('.gerer-ticket-btn').forEach(el => el.style.background = `linear-gradient(90deg, ${color} 60%, #42a5f5 100%)`);
          document.querySelector('h1').style.color = color;
        }
      });
      // Exportation des tickets en CSV
      document.getElementById('export-tickets-btn').onclick = function() {
        db.collection('tickets').get().then((querySnapshot) => {
          let csv = 'Nom,Email,Application,Titre,Description,Priorité,Date\n';
          querySnapshot.forEach((doc) => {
            const d = doc.data();
            csv += `"${d.lastname||''}","${d.userEmail||d.email||''}","${d.company||''}","${d.title||''}","${d.description||''}","${d.priority||''}","${d.createdAt ? (d.createdAt.seconds ? new Date(d.createdAt.seconds*1000).toLocaleString() : new Date(d.createdAt).toLocaleString()) : ''}"
`;
          });
          const blob = new Blob([csv], {type: 'text/csv'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'tickets.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          document.getElementById('export-success').textContent = "Export CSV généré !";
        });
      };
    </script>
    <!-- Ajout de la bibliothèque PapaParse pour la conversion en CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
