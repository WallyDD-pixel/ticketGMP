<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Créer une campagne annonceur</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(120deg, #e3f0ff 0%, #f5f5f5 100%); margin: 0; }
    .annonceur-container {
      max-width: 480px; margin: 40px auto; padding: 24px 16px; background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 18px #b3c6e0; min-height: 60vh;
    }
    h1 { color: #1976d2; font-size: 1.5em; margin-bottom: 0.5em; }
    label { display: block; margin-top: 10px; color: #333; font-weight: 500; font-size:0.98em; }
    .row-fields { display: flex; gap: 10px; margin-top: 6px; }
    .row-fields > * { flex: 1; min-width: 0; }
    .form-group { margin-bottom: 14px; }
    input, select, textarea {
      width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #b3c6e0;
      border-radius: 5px; font-size: 0.98em; background: #f9fbfd;
      box-sizing: border-box;
    }
    textarea { min-height: 70px; resize: vertical; }
    button {
      margin-top: 16px; width: 100%; padding: 10px; background: #1976d2; color: #fff;
      border: none; border-radius: 5px; font-size: 1em; cursor: pointer; transition: background 0.2s;
    }
    button:hover { background: #1251a3; }
    .success { color: #388e3c; margin-top: 10px; font-size:0.97em; }
    .error { color: #d32f2f; margin-top: 10px; font-size:0.97em; }
    @media (max-width: 600px) {
      .annonceur-container { padding: 10px 2vw; }
      .row-fields { flex-direction: column; gap: 0; }
      .form-group { margin-bottom: 10px; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <div class="annonceur-container">
    <div style="text-align:center;margin-bottom:18px;">
      <img src="gmp modif.png" alt="Logo GMP" style="max-width:220px;width:70%;height:auto;filter:drop-shadow(0 2px 8px #b3c6e0);border-radius:10px;">
    </div>
    <h1>Nouvelle campagne annonceur</h1>
    <form id="annonceur-form">
      <div class="form-group">
        <label for="campagne-nom">Nom de la campagne</label>
        <input type="text" id="campagne-nom" name="campagne-nom" required />
      </div>
      <div class="row-fields form-group">
        <div>
          <label for="date-debut">Début</label>
          <input type="date" id="date-debut" name="date-debut" required />
        </div>
        <div>
          <label for="date-fin">Fin</label>
          <input type="date" id="date-fin" name="date-fin" required />
        </div>
      </div>
      <div class="form-group">
        <label for="style-campagne">Style</label>
        <input type="text" id="style-campagne" name="style-campagne" placeholder="Ex : Affichage, Digital..." required />
      </div>
      <div class="form-group">
        <label for="type-campagne">Type</label>
        <select id="type-campagne" name="type-campagne" required>
          <option value="">Type</option>
          <option value="promotion">Promotion</option>
          <option value="nouveau produit">Nouveau produit</option>
          <option value="evenement">Événement</option>
          <option value="autre">Autre</option>
        </select>
      </div>
      <div class="form-group" id="type-autre-group" style="display:none;">
        <label for="type-autre">Précisez le type</label>
        <input type="text" id="type-autre" name="type-autre" placeholder="Décrivez le type de campagne" />
      </div>
      <div class="row-fields form-group">
        <div>
          <label for="zone">Zone</label>
          <select id="zone" name="zone" required>
            <option value="">Zone</option>
            <option value="france">France entière</option>
            <option value="region">Région</option>
            <option value="departement">Département</option>
          </select>
        </div>
        <div>
          <label for="zone-detail">Détail</label>
          <input type="text" id="zone-detail" name="zone-detail" placeholder="Région ou département" />
        </div>
      </div>
      <div class="form-group">
        <label for="campagne-images">Images (plusieurs possibles)</label>
        <input type="file" id="campagne-images" name="campagne-images" accept="image/*" multiple />
      </div>
      <div class="form-group">
        <label for="campagne-videos">Vidéos (plusieurs possibles)</label>
        <input type="file" id="campagne-videos" name="campagne-videos" accept="video/*" multiple />
      </div>
      <div class="form-group" style="margin-bottom:6px;">
        <div id="captcha-instruction" style="font-weight:500;margin-bottom:6px;"></div>
        <div id="captcha-images" style="display:flex;gap:10px;margin-bottom:8px;"></div>
        <div id="captcha-dropzone" style="border:2px dashed #b3c6e0;border-radius:6px;padding:12px;text-align:center;color:#1976d2;background:#f5faff;min-height:48px;transition:background 0.2s;">Glissez ici l'image demandée</div>
        <input type="hidden" id="captcha-valid" value="0" />
      </div>
      <button type="submit">Envoyer la campagne</button>
      <div class="success" id="annonceur-success"></div>
      <div class="error" id="annonceur-error"></div>
    </form>
  </div>
  <script>
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  // Captcha drag & drop d'image
  const captchaImagesList = [
    {src: 'https://upload.wikimedia.org/wikipedia/commons/6/6e/Golde33443.jpg', label: 'chat'},
    {src: 'https://upload.wikimedia.org/wikipedia/commons/3/3a/Dog_head.jpg', label: 'chien'},
    {src: 'https://upload.wikimedia.org/wikipedia/commons/4/47/PNG_transparency_demonstration_1.png', label: 'banane'},
    {src: 'https://upload.wikimedia.org/wikipedia/commons/2/2c/Rotating_earth_%28large%29.gif', label: 'terre'}
  ];
  let captchaTarget = null;
  function genererCaptchaDragDrop() {
    const idx = Math.floor(Math.random()*captchaImagesList.length);
    captchaTarget = captchaImagesList[idx];
    document.getElementById('captcha-instruction').textContent = `Glissez l'image du/de la « ${captchaTarget.label} » dans la zone ci-dessous :`;
    const shuffled = captchaImagesList.slice().sort(()=>Math.random()-0.5);
    const imgDiv = document.getElementById('captcha-images');
    imgDiv.innerHTML = '';
    shuffled.forEach((img, i) => {
      const el = document.createElement('img');
      el.src = img.src;
      el.alt = img.label;
      el.setAttribute('data-label', img.label);
      el.draggable = true;
      el.style.width = '54px';
      el.style.height = '54px';
      el.style.objectFit = 'cover';
      el.style.borderRadius = '6px';
      el.style.boxShadow = '0 2px 8px #b3c6e0';
      el.style.cursor = 'grab';
      el.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', img.label);
      });
      imgDiv.appendChild(el);
    });
    const dropzone = document.getElementById('captcha-dropzone');
    dropzone.style.background = '#f5faff';
    dropzone.textContent = 'Glissez ici l\'image demandée';
    document.getElementById('captcha-valid').value = '0';
  }
  document.addEventListener('DOMContentLoaded', () => {
    genererCaptchaDragDrop();
    const dropzone = document.getElementById('captcha-dropzone');
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.style.background = '#e3f0ff';
    });
    dropzone.addEventListener('dragleave', (e) => {
      dropzone.style.background = '#f5faff';
    });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.style.background = '#f5faff';
      const label = e.dataTransfer.getData('text/plain');
      if(label === captchaTarget.label) {
        dropzone.textContent = `✔️ Bravo, bonne image !`;
        document.getElementById('captcha-valid').value = '1';
      } else {
        dropzone.textContent = `❌ Mauvaise image, réessayez.`;
        document.getElementById('captcha-valid').value = '0';
      }
    });
  });

  // Affichage dynamique du champ "Précisez le type"
  const typeSelect = document.getElementById('type-campagne');
  const typeAutreGroup = document.getElementById('type-autre-group');
  const typeAutreInput = document.getElementById('type-autre');
  typeSelect.addEventListener('change', function() {
    if (this.value === 'autre') {
      typeAutreGroup.style.display = '';
      typeAutreInput.required = true;
    } else {
      typeAutreGroup.style.display = 'none';
      typeAutreInput.required = false;
      typeAutreInput.value = '';
    }
  });

  document.getElementById('annonceur-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const nom = document.getElementById('campagne-nom').value.trim();
    const dateDebut = document.getElementById('date-debut').value;
    const dateFin = document.getElementById('date-fin').value;
    const style = document.getElementById('style-campagne').value.trim();
    let type = document.getElementById('type-campagne').value.trim();
    let typeAutre = document.getElementById('type-autre').value.trim();
    const zone = document.getElementById('zone').value;
    const zoneDetail = document.getElementById('zone-detail').value.trim();
    const images = document.getElementById('campagne-images').files;
    const videos = document.getElementById('campagne-videos').files;
    const successDiv = document.getElementById('annonceur-success');
    const errorDiv = document.getElementById('annonceur-error');
    const submitBtn = document.querySelector('#annonceur-form button[type="submit"]');
    successDiv.textContent = '';
    errorDiv.textContent = '';

    if (!nom || !dateDebut || !dateFin || !style || !type || !zone) {
      errorDiv.textContent = "Merci de remplir tous les champs obligatoires.";
      return;
    }
    const captchaValid = document.getElementById('captcha-valid').value === '1';
    if (!captchaValid) {
      errorDiv.textContent = "Merci de glisser la bonne image dans la zone de vérification.";
      genererCaptchaDragDrop();
      return;
    }
    if(type === 'autre') {
      if(!typeAutre) {
        errorDiv.textContent = "Merci de préciser le type de campagne.";
        return;
      }
      type = typeAutre;
    }
    submitBtn.disabled = true;
    submitBtn.textContent = "Envoi en cours...";
    let imageUrls = [];
    let videoUrls = [];
    try {
      for (let i = 0; i < images.length; i++) {
        const file = images[i];
        const ext = file.name.split('.').pop();
        const storageRef = storage.ref().child(`campagnes/images/${Date.now()}_${i}_${nom.replace(/\s/g, '_')}.${ext}`);
        await storageRef.put(file);
        const url = await storageRef.getDownloadURL();
        imageUrls.push(url);
      }
      for (let i = 0; i < videos.length; i++) {
        const file = videos[i];
        const ext = file.name.split('.').pop();
        const storageRef = storage.ref().child(`campagnes/videos/${Date.now()}_${i}_${nom.replace(/\s/g, '_')}.${ext}`);
        await storageRef.put(file);
        const url = await storageRef.getDownloadURL();
        videoUrls.push(url);
      }
    } catch (err) {
      errorDiv.textContent = "Erreur lors de l'upload des fichiers : " + err.message;
      submitBtn.disabled = false;
      submitBtn.textContent = "Envoyer la campagne";
      return;
    }
    db.collection('campagnes').add({
      nom,
      dateDebut,
      dateFin,
      style,
      type,
      zone,
      zoneDetail,
      images: imageUrls,
      videos: videoUrls,
      createdAt: new Date()
    })
    .then(() => {
      successDiv.textContent = "Campagne envoyée avec succès !";
      document.getElementById('annonceur-form').reset();
      genererCaptchaDragDrop();
    })
    .catch((err) => {
      errorDiv.textContent = "Erreur lors de l'envoi de la campagne : " + err.message;
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = "Envoyer la campagne";
    });
  });
  </script>
</body>
</html>
